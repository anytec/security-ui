<template>
   <div class="main_box">
       <div class="bg_box">
           <video autoplay="autoplay" loop="loop">
              <source src="../assets/login/login_bg.mp4" type="video/mp4">
                        您的浏览器不支持 video 标签。
           </video>
       </div>
       <div class="main_content">
           <div class="content_box">
                <div class="left_box">
                    <div class="logo">
                        <img src="../assets/logo.png" />
                    </div>
                    <div class="system_name">恩钛人脸识别系统<span>V 1.0</span></div>
                    <div class="en_name">Face recognition system by Anytec</div>
                    <div class="system_text">人员身份鉴定、人员行踪检索<br/></div>
                </div>
                <div class="right_box">
                    <div class="shadow"><img src="../assets/login/shadow.png"/></div>
                    <div  ref="loginForm" class="logo_box">
                        <div class="login_title">
                            <div class="left_title"><p>账号登录</p></div>
                            <div class="right_title"></div>
                        </div>
                        <div class="user_name">
                            <div class="left_icon">
                                <img src="../assets/login/user.png" />
                            </div>
                            <div class="right_input">
                                <input v-model="user.name" type="text" placeholder="用户名"/>
                            </div>
                        </div>
                        <div class="user_pwd">
                            <div class="left_icon">
                                <img src="../assets/login/pwd.png" />
                            </div>
                            <div class="right_input pwd_inut" @keyup.enter="login">
                                <input v-model="user.password" :type="pass_type" id="pwd" placeholder="密码"/>
                            </div>
                            <div class="eyes">
                                <img :src="imgurl" @click="change_view"/>
                            </div>
                        </div>
                        <div class="remember">
                            <input type="checkbox" :checked="isrem_password" v-model="isrem_password"/>
                            <div class="remember_text">记住密码</div>
                        </div>
                        <div class="logo_input" @click="login">登录</div>
                        <div class="xian"></div>
                        <div class="prompt">温馨提示：<br/>如果您已忘记密码，请及时与管理员联系！</div>
                    </div>
                </div>
            </div>
       </div>
       <div class="footer_1">系统版本V1.0 请使用谷歌浏览器登陆平台 建议分辨率：1920*1080 <a target="_blank" href="https://www.google.cn/intl/zh-CN/chrome/">工具下载</a></div>
        <div class="footer_2">Copyright 2017 All Right Reserved 深圳市恩钛控股有限公司 ICP:08118166</div>
   </div>

</template>

<script>
    export default {
        data () {
            return {
                imgurl: require("../assets/login/eyes.png"),
                pass_type: "password",
                user: {},
                isrem_password: false,
                post_flag: false,
            }
        },
        methods: {
            login: function() {
                if ( !this.user.name || !this.user.password){
                    this.$message({
                        type: 'error',
                        message: '账号密码不能为空',
                        showClose: true,
                        center: true
                    })
                    return false
                }
                this.post_to_login()
            },
            change_view:function(){
                if( this.imgurl == require("../assets/login/eyes.png") ){
                    this.imgurl = require("../assets/login/eyes2.png")
                    this.pass_type = "text"
                }else{
                    this.imgurl = require("../assets/login/eyes.png")
                    this.pass_type = "password"
                }
            },
            post_to_login:function(){
                var params = new URLSearchParams()
                params.append("uname",this.user.name)
                params.append("upass",this.user.password)
                this.$ajax.post("/user/login",params).then((res) => {
                    if( res.data.status === 0){
                        sessionStorage.setItem("username", res.data.data.uname)
                        this.$store.dispatch('login', res.data.data)
                        // console.log(this.$store.state.user.role)
                        this.$notify({
                            type: 'success',
                            message: '欢迎你' + res.data.data.uname + '!',
                            duration: 3000
                        })
                        if( this.isrem_password ){
                            this.setCookie( this.user.name,this.user.password,7 )
                        }else{
                            this.clearCookie()
                        }
                        this.$router.replace('/dataview')
                    }else{
                        this.error_info(res.data.msg)
                    }
                }).catch((error) => {
                    console.log(error)
                    this.error_info('网络连接出错')
                    return ;
                })
            },
            // 消息窗口
            error_info:function(mes){
                this.$message({
                    type: 'error',
                    message: mes,
                    showClose: true,
                    center: true
                })
            },

            //设置cookie
            setCookie(c_name, c_pwd, exdays) {
                // this.clearCookie()
                let exdate = new Date(); //获取时间
                exdate.setTime(exdate.getTime() + 24 * 60 * 60 * 1000 * exdays); //保存的天数
                //字符串拼接cookie
                window.document.cookie = "uname" + "=" + c_name + ";path=/;expires=" + exdate.toGMTString();
                window.document.cookie = "upass" + "=" + c_pwd + ";path=/;expires=" + exdate.toGMTString();
            },
            //读取cookie
            getCookie: function() {
                if (document.cookie.length > 0) {
                    let arr = document.cookie.split('; '); //这里显示的格式需要切割一下自己可输出看下
                    for (let i = 0; i < arr.length; i++) {
                        let arr2 = arr[i].split('='); //再次切割
                        //判断查找相对应的值
                        if (arr2[0] == 'uname') {
                            this.user.name = arr2[1]; //保存到保存数据的地方
                        } else if (arr2[0] == 'upass') {
                            this.user.password = arr2[1];
                        }
                        this.isrem_password = true
                    }
                }
            },
            //清除cookie
            clearCookie: function() {
                this.setCookie("", "", -1); //修改2值都为空，天数为负1天就好了
            }
        },
        mounted(){
            if( this.$store.state.user.username === "" ){
                this.user = {}
            }
            this.getCookie()
        },
    }

</script>

<style scoped>
    @import "../css/login.css";
</style>